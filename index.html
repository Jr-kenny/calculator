<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Onchain Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      background: #111;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .calculator {
      width: 350px;
      background: #1a1a1a;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    #display {
      width: 100%;
      height: 80px;
      font-size: 32px;
      font-weight: bold;
      text-align: right;
      margin-bottom: 15px;
      border-radius: 10px;
      padding: 10px;
      background: #000;
      color: #0f0;
      border: none;
    }
    .buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    button {
      font-size: 26px;
      font-weight: bold;
      padding: 20px;
      border-radius: 12px;
      border: none;
      background: #333;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background: #444;
    }
    .op {
      background: #ff9800;
      color: black;
    }
    .op:hover {
      background: #e68900;
    }
    #connectBtn {
      width: 100%;
      padding: 15px;
      font-size: 20px;
      margin-bottom: 15px;
      border-radius: 12px;
      border: none;
      background: #2196f3;
      color: white;
      cursor: pointer;
    }
    #connectBtn:hover {
      background: #1976d2;
    }
    @media (max-width: 500px) {
      .calculator { width: 95%; }
      button { font-size: 22px; padding: 18px; }
      #display { font-size: 28px; }
    }
  </style>
</head>
<body>
  <div class="calculator">
    <button id="connectBtn">üîó Connect Wallet</button>
    <input type="text" id="display" disabled value="0">
    <div class="buttons">
      <button onclick="press('7')">7</button>
      <button onclick="press('8')">8</button>
      <button onclick="press('9')">9</button>
      <button class="op" onclick="setOp('div')">√∑</button>

      <button onclick="press('4')">4</button>
      <button onclick="press('5')">5</button>
      <button onclick="press('6')">6</button>
      <button class="op" onclick="setOp('mul')">√ó</button>

      <button onclick="press('1')">1</button>
      <button onclick="press('2')">2</button>
      <button onclick="press('3')">3</button>
      <button class="op" onclick="setOp('sub')">‚àí</button>

      <button onclick="press('0')">0</button>
      <button onclick="clearDisplay()">C</button>
      <button onclick="calculate()">=</button>
      <button class="op" onclick="setOp('add')">+</button>
    </div>
  </div>

  <script>
    const CONTRACT_ADDRESS = "0x0640761a8AaF04Ef63708789189b8beD47AA338A";
    const CONTRACT_ABI = [
      "function add(uint256 a, uint256 b) public returns (uint256)",
      "function sub(uint256 a, uint256 b) public returns (uint256)",
      "function mul(uint256 a, uint256 b) public returns (uint256)",
      "function div(uint256 a, uint256 b) public returns (uint256)"
    ];

    let provider, signer, contract;
    let current = "";
    let num1 = null;
    let operator = null;

    const display = document.getElementById("display");
    const connectBtn = document.getElementById("connectBtn");

    async function connectWallet() {
      if (!window.ethereum) {
        alert("MetaMask not found!");
        return;
      }
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

      // Switch to Fluent Testnet
      try {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: "0x5202" }] // 20994 in hex
        });
      } catch (e) {
        if (e.code === 4902) {
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [{
              chainId: "0x5202",
              chainName: "Fluent Testnet",
              rpcUrls: ["https://rpc.testnet.fluent.xyz"],
              nativeCurrency: { name: "Ethereum", symbol: "ETH", decimals: 18 },
              blockExplorerUrls: ["https://testnet.fluentscan.xyz"]
            }]
          });
        }
      }
      connectBtn.innerText = "‚úÖ Connected";
    }

    connectBtn.onclick = connectWallet;

    function press(num) {
      current += num;
      display.value = current;
    }

    function clearDisplay() {
      current = "";
      num1 = null;
      operator = null;
      display.value = "0";
    }

    function setOp(op) {
      if (current === "") return;
      num1 = current;
      current = "";
      operator = op;
    }

    async function calculate() {
      if (!operator || !num1 || current === "") return;
      let num2 = current;
      display.value = "‚è≥ Sending Tx...";
      try {
        let tx;
        if (operator === "add") tx = await contract.add(num1, num2);
        if (operator === "sub") tx = await contract.sub(num1, num2);
        if (operator === "mul") tx = await contract.mul(num1, num2);
        if (operator === "div") tx = await contract.div(num1, num2);

        display.value = "‚è≥ Waiting Confirm...";
        let receipt = await tx.wait();
        display.value = "‚úÖ Tx: " + receipt.transactionHash.slice(0,12) + "...";
      } catch (err) {
        console.error(err);
        display.value = "‚ùå Tx Failed";
      }
      current = "";
      num1 = null;
      operator = null;
    }
  </script>
</body>
</html>
